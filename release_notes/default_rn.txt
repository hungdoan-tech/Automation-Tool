Enhance the code quality, fix some potential bugs